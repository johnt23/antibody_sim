{
    "collab_server" : "",
    "contents" : "# om_exploration.R\n# Created by John Trochta\n# Date created: 06/20/2020\n# Run simulation model from R of the disease antibodies\nrm(list=ls(all=TRUE)) #clears workspace\n\nsource(here::here(\"src/vhs_age_stage_om.R\"))\nsource(here::here(\"src/fun_obs_mod.R\"))\n\nnyr=100\nnage=8\nnstage=3\nndays=120\navg_waa=c(70, 94, 115, 134, 150, 160, 165, 168)\n\nsurvey_selA50 <- 3\nsurvey_selA95 <- 4\nmaturity_A50 <- 3\nmaturity_A95 <- 4\ndisease_vulA50 <- 3\ndisease_vulA95 <- 4\ndis_survey_selA50 <- 3\ndis_survey_selA95 <- 4\n\nselA50 = 3\nselA95 = 4\nlog_sigma_R = 0.1823216\nnonlinear_exp_1 = 1\nnonlinear_exp_2 = 1\nsig_nat_mor = 0\n\nignore.carryover.inf <- TRUE\n\n# VHS per capita epidemiological rates (day^-1)\n# Frequency dependence value\n# vhs_trans_rate_I=0\n# vhs_trans_rate_C=0\n\nvhs_trans_rate_I=0.01\nvhs_trans_rate_C=0.000001\n\n# vhs_trans_rate_I=0.0001\n# vhs_trans_rate_C=0.00000001\n\n#vhs_mort_rate=rep(30/365,times=nyr) # 11/365\n#vhs_rec_rate=rep(5/365,times=nyr) # 26/365\n\nvhs_mort_rate=rep(11/365,times=nyr) # 11/365\nvhs_rec_rate=rep(26/365,times=nyr) # 26/365\n# vhs_mort_rate = runif(nyr,9/365,21/365)\n# vhs_rec_rate = runif(nyr,20/365,70/365) # 26/365\n\n# Dependency scaling:\n# This is an exponent in the transmission rate function that allows\n# scaling from frequency dependent (dep_scaling=0) to density \n# dependent (dep_scaling=1)\ndep_scaling=0\n\n# Fishing mortality rate (year^-1)\n# fishing_mort=c(rep(0,times=150),seq(0.05,0.4,length.out=20),rep(0.4,times=10),rep(0.05,times=10),rep(0.2,times=10))\nfishing_mort=rep(0,times=nyr)\n\n# Disease prevalence sampling dates (Generate random sequential dates within the first month of transmission)\ninf_prev_survey <- round(runif(nyr,5,30))\ninf_prev_survey <- cbind(inf_prev_survey,inf_prev_survey + round(runif(nyr,1,5)))\ninf_prev_survey <- cbind(inf_prev_survey,inf_prev_survey[,2] + round(runif(nyr,1,5)))\n\n# rseed = ceiling(runif(1,50,10000000)) # 90854094 # 2770367\nrseed = 2770367\nset.seed(rseed)\n\n#rseed <- runif(1,100,10^7) #18314367\nptm <- proc.time()\nrun.1 = vhs.asa(nyr,nage,nstage,ndays,avg_waa,vhs_trans_rate_I,vhs_trans_rate_C,vhs_mort_rate,vhs_rec_rate,dep_scaling,\n                fishing_mort,survey_selA50,survey_selA95,maturity_A50,maturity_A95,disease_vulA50,disease_vulA95,dis_survey_selA50,dis_survey_selA95,\n                nonlinear_exp_1,nonlinear_exp_2,sig_nat_mor,selA50,selA95,ignore.carryover.inf,inf_prev_survey,log_sigma_R,rseed)\nproc.time()-ptm\n# Model checks - make sure dynamics from model are sensible\n\nlist2env(run.1,globalenv())\n\n# All years - divide by Post_out_Nya from previous year\n# Infection intensity by year\ninfection.intensity <- (apply(Nya_new_infect[,-nage],1,sum)/apply(Nya[,-nage],1,sum))\n# Disease mortality by year\ndisease.mortality <- (apply(Nya_dis_death[,-nage],1,sum)/apply(Nya[,-nage],1,sum))\n# Natural survival by year\n# total.survival <- (rowSums(Nya[,-nage]*Sya[,-nage]) + Nya[,nage]*Sya[,nage])/(rowSums(Nya[,-nage]) + Nya[,nage])\n# total.survival <- (rowSums(Nya[,-nage]*Sya[,-nage]))/(rowSums(Nya[,-nage]))\ntotal.survival <- (rowSums(Nya*Sya))/(rowSums(Nya))\n\n# (Nya[,nage]*Sya[,nage])/Nya[,nage]\n# Immunity (Antibody prevalence)\n# immunity <- (N_y_recovered[,ndays]/apply(Post_out_Nya,1,sum))\nimmunity <- (apply(Nya_imm[,-nage],1,sum)/apply(Nya[,-nage],1,sum))\n\nN_y_daily <- N_y_susceptible + N_y_infected + N_y_recovered\n\n##################################\n# Daily and annual dynamics\n##################################\n# years = (nyr-499):nyr\nyears = (nyr-49):nyr\n# years = (151):200\n\nfig.name <- paste0(here::here(\"results/figures/\"),\"Figure_Example 50 year dynamics from seed \",round(rseed),\".tiff\")\ntiff(file=fig.name,width=9, height=6, units=\"in\", res=200)\n\npar(xpd=NA,oma=c(4,0,0,0))\nlayout(matrix(1:6,3,2,byrow=FALSE))\n\n# Plot prevalence\npar(mar=c(0,4,1,2))\nmatplot(t(N_y_susceptible/N_y_daily)[,years],type=\"l\",lty=1,ylab=\"\",col=colorRampPalette(c(\"grey20\",\"grey90\"))(50), xaxt='n', yaxt='n', lwd=2,ylim=c(0,1))\naxis(side =1, seq(0,ndays,by=ndays/3), labels = F)\naxis(2, at = c(0,0.5,1),labels=c(0,0.5,1))\ntext(0,0.95,labels='A',cex=1.6,adj=c(0,0.5),font=2)\ntitle(ylab=\"Susceptible prevalence\", line=2.5, cex.lab=1.4)\n\nmatplot(t(N_y_infected/N_y_daily)[,years],type=\"l\",lty=1,ylab=\"\",col=colorRampPalette(c(\"grey20\",\"grey90\"))(50), xaxt='n', yaxt='n',lwd=2,ylim=c(0,1))\naxis(side =1, seq(0,ndays,by=ndays/3), labels = F)\naxis(2, at = c(0,0.5,1),labels=c(0,0.5,1))\ntext(0,0.95,labels='B',cex=1.6,adj=c(0,0.5),font=2)\ntitle(ylab=\"Infection prevalence\", line=2.5, cex.lab=1.4)\n\npar(mar=c(0,4,1,2))\nmatplot(t(N_y_recovered/N_y_daily)[,years],type=\"l\",lty=1,ylab=\"\", xlab=\"\",col=colorRampPalette(c(\"grey20\",\"grey90\"))(50),lwd=2,ylim=c(0,1), xaxt='n', yaxt='n')\naxis(side =1, seq(0,ndays,by=ndays/3), labels = T)\naxis(2, at = c(0,0.5,1),labels=c(0,0.5,1))\ntext(0,0.95,labels='C',cex=1.6,adj=c(0,0.5),font=2)\ntitle(ylab=\"Seroprevalence\", line=2.5, cex.lab=1.4)\ntitle(xlab=\"Days\", line=2.5, cex.lab=1.4)\n\n# Plot muti-plot of spawning biomass, recruitment, and outbreak severity in the last 50 years\n# par(mfrow=c(3,1))\nplot(apply(SSB_atage,1,sum)[years],type=\"l\",xlab=\"\",ylab=\"\",\n     yaxt=\"n\",\n     xaxt = \"n\",\n     ylim=c(0,signif(ceiling(max(apply(SSB_atage,1,sum)[years])),digits=2)),lwd=2)\npoints(apply(SSB_atage,1,sum)[years],pch=21,bg=colorRampPalette(c(\"grey20\",\"grey90\"))(50),cex=1.5)\naxis(2, at = seq(0, signif(ceiling(max(apply(SSB_atage,1,sum)[years])),digits=1), length.out = 3),\n     labels=seq(0, signif(ceiling(max(apply(SSB_atage,1,sum)[years])),digits=1), length.out = 3)/1000)\naxis(side =1, seq(0,length(years),by=25), labels = F)\ntitle(ylab=\"Spawning biomass\\n(1000 tons)\", line=2.5, cex.lab=1.4)\ntext(0,0.95*max(apply(SSB_atage,1,sum)[years]),labels='D',cex=1.6,adj=c(0,0.5),font=2)\n\nplot(Nya[,1][years],type=\"l\",xlab=\"\",ylab=\"\",ylim=c(0,signif(ceiling(max(Nya[,1][years])),digits=2)), xaxt='n',lwd=2)\npoints(Nya[,1][years],pch=21,bg=colorRampPalette(c(\"grey20\",\"grey90\"))(50),cex=1.5)\naxis(side =1, seq(0,length(years),by=25), labels = F)\ntitle(ylab=\"Recruits (millions)\", line=2.5, cex.lab=1.4)\ntext(0,0.95*max(Nya[,1][years]),labels='E',cex=1.6,adj=c(0,0.5),font=2)\n\nplot(immunity[years],type=\"l\",xlab=\"\",ylab=\"\",ylim=c(0,1.1),lwd=3,lty=\"solid\", xaxt='n',yaxt='n',col=\"purple4\")\nlines(infection.intensity[years],lwd=4.5,col=\"darkorange2\")\nlines(total.survival[years],lwd=3, col=\"seagreen3\")\naxis(side =2, c(0,0.25,0.5,0.75,1), labels = c(0,25,50,75,100))\naxis(side =1, seq(0,length(years),by=25), labels = c(50, 75, 100))\ntitle(ylab=\"Percentages\", line=2.5, cex.lab=1.4)\ntitle(xlab=\"Years\", line=2.5, cex.lab=1.4)\ntext(0,0.95*1.1,labels='F',cex=1.6,adj=c(0,0.5),font=2)\n\nlegend(28,1.15,\n       c('% survived','% with antibodies','% infected'),\n       #horiz = TRUE,\n       #cex=1.2,\n       lwd=2.5,\n       inset=c(0,0),\n       x.intersp=0.3,\n       y.intersp = 0.9,\n       # col=c('grey40','grey70','black'),\n       col=c(\"seagreen3\",\"purple4\",\"darkorange2\"),\n       #lty = c(\"twodash\",\"solid\",\"dotted\"),\n       box.lty=0, bg=NA)\n\ndev.off()\n\n##################################\n# Cross-correlations\n##################################\n\ncustom.ccf <- function(x,y,lags,...){\n  rho <- vector(length=2*lags+1)\n  sig.level <- vector(length=2*lags+1)\n  k <- 1\n  for(i in -lags:lags){\n    indexing <- (1:length(x))+i # reference indices\n    indexing <- ifelse(indexing<=0 | is.na(indexing),NA,indexing)\n    block <- data.frame(x=x[indexing],y=y)\n    block <- block[!is.na(block$x),]\n    if(NROW(block)<=5){\n      rho[k] <- NA\n      sig.level[k] <- NA\n    }else{\n      temporary <- cor.test(x=as.ts(block$x),y=as.ts(block$y),method=\"spearman\",na.action=na.pass)\n      rho[k] <- temporary$estimate\n      sig.level[k] <- qnorm((1 + 0.95)/2)/sqrt(sum(!is.na(block$x)))\n    }\n    k <- k+1\n  }\n  \n  output <- data.frame(lags=-lags:lags,\n                       correlations=rho,\n                       significance.level=sig.level)\n  \n  return(output)\n}\n\nyears.2 <- 100:nyr\n# cc.inf.vs.rec <- ccf(Nya[,1][years.2],infection.intensity[years.2],plot=FALSE,lag.max=10)\n# cc.inf.vs.rec <- custom.ccf(x=(Nya[,1]/apply(Nya,1,sum))[years.2],y=infection.intensity[years.2],lags=10)\ncc.inf.vs.rec <- custom.ccf(x=(Nya[,1])[years.2],y=infection.intensity[years.2],lags=10)\ncc.imm.vs.sur <- custom.ccf(x=immunity[years.2],y=total.survival[years.2],lags=10)\ncc.sur.vs.inf <- custom.ccf(x=infection.intensity[years.2],y=total.survival[years.2],lags=10)\ncc.imm.vs.inf <- custom.ccf(x=infection.intensity[years.2],y=immunity[years.2],lags=10)\n\ncc.rec.vs.rec <- custom.ccf(x=(Nya[,1])[years.2],y=(Nya[,1])[years.2],lags=10)\n\nfig.name <- paste0(here::here(\"results/figures/\"),\"Figure_Cross correlations from seed \",round(rseed),\".tiff\")\ntiff(file=fig.name,width=8, height=6, units=\"in\", res=200)\n\npar(xpd=NA,mfrow=c(2,2))\npar(oma=c(3,3,1,1),mar=c(0,0,0,0))\nplot(x=cc.inf.vs.rec$lags,y=cc.inf.vs.rec$correlations,ylab=\"\",\n     xlab=\"\",t=\"n\",main=NA,ylim=c(-1,1),cex.lab=1,cex.axis=0.9,xaxt='n')\npolygon(x=c(cc.inf.vs.rec$lags,rev(cc.inf.vs.rec$lags)),y=c(cc.inf.vs.rec$significance.level,-rev(cc.inf.vs.rec$significance.level)),col=\"grey80\",border=NA)\nsegments(x0=-10,x1=10,y0=0)\nsegments(x0=cc.inf.vs.rec$lags,y0=0,y1=cc.inf.vs.rec$correlations,lwd=5,lend=1)\ntext(-10, 0.9, label=\"A. Infection incidence vs Recruits (lagged)\",adj=0,cex=1,font=2)\n# points(x=cc.inf.vs.rec$lags,y=cc.inf.vs.rec$correlations,pch=21,bg=\"white\",cex=1.2)\n# lines(x=cc.inf.vs.rec$lags,y=cc.inf.vs.rec$significance.level,col=\"blue\",lty=\"dashed\")\n# lines(x=cc.inf.vs.rec$lags,y=-cc.inf.vs.rec$significance.level,col=\"blue\",lty=\"dashed\")\n\nplot(x=cc.sur.vs.inf$lags,y=cc.sur.vs.inf$correlations,ylab=\"\",xlab=\"\",\n     t=\"n\",main=NA,ylim=c(-1,1),yaxt='n',xaxt='n', cex.lab=1,cex.axis=0.9)\npolygon(x=c(cc.sur.vs.inf$lags,rev(cc.sur.vs.inf$lags)),y=c(cc.sur.vs.inf$significance.level,-rev(cc.sur.vs.inf$significance.level)),col=\"grey80\",border=NA)\nsegments(x0=-10,x1=10,y0=0)\nsegments(x0=cc.imm.vs.sur$lags,y0=0,y1=cc.imm.vs.sur$correlations,lwd=5,lend=1)\ntext(-10, 0.9, label=\"B. Survival vs Infection incidence (lagged)\",adj=0,cex=1,font=2)\n\nplot(x=cc.imm.vs.inf$lags,y=cc.imm.vs.inf$correlations,ylab=\"\",xlab=\"\",\n     t=\"n\",main=NA,ylim=c(-1,1),cex.lab=1,cex.axis=0.9)\npolygon(x=c(cc.imm.vs.inf$lags,rev(cc.imm.vs.inf$lags)),y=c(cc.imm.vs.inf$significance.level,-rev(cc.imm.vs.inf$significance.level)),col=\"grey80\",border=NA)\nsegments(x0=-10,x1=10,y0=0)\nsegments(x0=cc.imm.vs.inf$lags,y0=0,y1=cc.imm.vs.inf$correlations,lwd=5,lend=1)\ntext(-10, 0.9, label=\"C. Seroprevalence vs Infection incidence (lagged)\",adj=0,cex=1,font=2)\n\nplot(x=cc.imm.vs.sur$lags,y=cc.imm.vs.sur$correlations,ylab=\"\",xlab=\"\",\n     t=\"n\",main=NA,ylim=c(-1,1),yaxt='n',cex.lab=1,cex.axis=0.9)\npolygon(x=c(cc.imm.vs.sur$lags,rev(cc.imm.vs.sur$lags)),y=c(cc.imm.vs.sur$significance.level,-rev(cc.imm.vs.sur$significance.level)),col=\"grey80\",border=NA)\nsegments(x0=-10,x1=10,y0=0)\nsegments(x0=cc.imm.vs.sur$lags,y0=0,y1=cc.imm.vs.sur$correlations,lwd=5,lend=1)\ntext(-10, 0.9, label=\"D. Survival vs Seroprevalence (lagged)\",adj=0,cex=1,font=2)\n# points(x=cc.imm.vs.sur$lags,y=cc.imm.vs.sur$correlations,pch=21,bg=\"white\",cex=1.2)\n# lines(x=cc.imm.vs.sur$lags,y=cc.imm.vs.sur$significance.level,col=\"blue\",lty=\"dashed\")\n# lines(x=cc.imm.vs.sur$lags,y=-cc.imm.vs.sur$significance.level,col=\"blue\",lty=\"dashed\")\n\ntitle(ylab=\"Cross correlation\",xlab=\"Lags (years)\",outer=TRUE,line=2)\ndev.off()\n\n#plot(lag(immunity[years.2],7),total.survival[years.2])\n#plot(rank(lag(immunity[years.2],7)),rank(total.survival[years.2]))\n\n\n##################################\n# Age-specific mortality over time\n##################################\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(reshape2)\n\n# Melt matrices (nyr x nage) of survival, mortality rates, and immunity\nage_survival <- reshape2::melt(Sya,varnames=c(\"Year\",\"Age\"),value.name=\"Survival\")\nadd_mort <- t(apply(Sya,1,function(x) -log(x)))\nadd_mort <- reshape2::melt(add_mort,varnames=c(\"Year\",\"Age\"),value.name=\"Mortality\")\nage_immune <- reshape2::melt(predicted_immune_comps,varnames=c(\"Year\",\"Age\"),value.name=\"Seroprevalence\")\nage_comp <- t(apply(Nya,1,function(x) x/sum(x)))\nage_comp <- reshape2::melt(age_comp,varnames=c(\"Year\",\"Age\"),value.name=\"Age_Comp\")\ninfection_incidence <- reshape2::melt(Nya_new_infect/Nya,varnames=c(\"Year\",\"Age\"),value.name=\"Infection incidence\")\n\n# Combine everything\nmort_vs_immune <- full_join(full_join(age_survival,add_mort,by=c(\"Year\",\"Age\")),age_immune,by=c(\"Year\",\"Age\"))\nmort_vs_immune <- full_join(mort_vs_immune,age_comp,by=c(\"Year\",\"Age\"))\nmort_vs_immune <- full_join(mort_vs_immune,infection_incidence,by=c(\"Year\",\"Age\"))\n\nmort_vs_immune$Age <- mort_vs_immune$Age-1 # Correct to actual ages\n\n# Omit first 150 years\nyears.4.analysis <- 50:74\n\n# Now melt with just immune, survival, and infection probabilities\n# mort_vs_immune <- reshape2::melt(select(mort_vs_immune,-Age_Comp,-Mortality),id.vars=c(\"Year\",\"Age\"))\ndat.2.plot <- reshape2::melt(select(mort_vs_immune,-Age_Comp,-Mortality,-'Seroprevalence',-'Infection incidence'),id.vars=c(\"Year\",\"Age\"))\n\n# This is the immunity following this year's mortality\nbaseline<- data.frame(Year=years.4.analysis, value=exp(-0.25))\n\ndat.2.plot <- filter(dat.2.plot,Year %in% years.4.analysis) %>% mutate(Year=Year,\n                                                                           Age=Age,\n                                                                           Age_lwd=(7-Age)*0.1+0.2)\nfont.size <- 14\n\nA.plot <- ggplot(data=dat.2.plot) +\n  geom_line(aes(x=Year,y=value,group=interaction(Age,variable),colour=factor(Age),size=factor(Age)))+\n  #geom_line(data=baseline,aes(x=Year,y=value),color=\"black\",linetype=\"dashed\",lwd=2)+\n  ylab(\"Survival\") + \n  scale_size_manual(breaks=0:7,values=seq(2.25,0.5,length.out=8),\n                    labels=c(0:6,\"7+\"))+\n  scale_color_manual(values = c(\"olivedrab2\",\"lightgoldenrod\", \"orange\", \"firebrick2\", \"darkmagenta\", \"blue\", \"cyan3\",\"black\"),\n                     labels=c(0:6,\"7+\")) +\n  theme_classic()+\n  guides(colour = guide_legend(nrow = 1), size=guide_legend(nrow=1)) +\n  #scale_y_continuous(limits=c(0,1))+\n  #scale_y_continuous(limits=c(0.25,1),breaks=c(0,0.25,0.5,0.75,1),labels=c(0,\"\",0.5,\"\",1))+\n  scale_y_continuous(limits=c(0.5,0.9))+\n  theme(#axis.title.y.left = element_text(color = \"darkblue\"),\n    #axis.title.y.right = element_text(color = \"darkorange\"),\n    #axis.text.y.left = element_text(color = \"darkblue\"),\n    #axis.text.y.right = element_text(color = \"orange\"),\n    #axis.line.y.right = element_line(color = \"orange\"),\n    #axis.ticks.y.right = element_line(color = \"orange\"),\n    axis.title.x = element_text(size=font.size),\n    axis.title.y = element_text(size=font.size),\n    axis.text.y = element_text(size=font.size-4,hjust=0.5,angle=90),\n    axis.text.x = element_text(size=font.size-4),\n    text=element_text(size=15),\n    legend.position=c(0.05,0.1),\n    legend.title = element_blank(),\n    legend.justification = c(0,0.5),\n    legend.text=element_text(size=font.size-3),\n    legend.background = element_blank(),\n    panel.border = element_rect(color=\"black\", fill=NA))\n# dev.off()\n\n##################################\n# Cohort effects\n##################################\n\n# Create indices for cohorts\ncohort.indices <- data.frame(Cohort=1,Age=0:(nage-1),Year=1:nage)\nfor(y in 2:nyr){\n  cohort.indices <- rbind(cohort.indices,data.frame(Cohort=y,Age=0:(nage-1),Year=y:(y-1+nage)))\n}\n\n# Label as cohorts\nmort_vs_immune_2 <- mort_vs_immune %>% mutate(Cohort=cohort.indices$Cohort[prodlim::row.match(select(mort_vs_immune,Year,Age),select(cohort.indices,Year,Age))])\n\n# Now melt with just immune, survival, and infection probabilities\nmort_vs_immune_2 <- reshape2::melt(select(mort_vs_immune_2,-Age_Comp,-Mortality),id.vars=c(\"Cohort\",\"Year\",\"Age\"))\n\n# This is the immunity following this year's mortality\nbaseline <- data.frame(Age=0:(nage-1),value=c(rep(exp(-0.25),times=nage-1),exp(-1.8)))\n\ndat.2.plot <- filter(mort_vs_immune_2,Cohort %in% years.4.analysis[1:9]) %>% mutate(Cohort=Cohort)\n\nB.plot <- ggplot(data=dat.2.plot) +\n  geom_point(aes(x=Age,y=value,group=Cohort,colour=variable,shape=variable),size=2)+\n  geom_line(aes(x=Age,y=value,group=interaction(Cohort,variable),colour=variable),size=1)+\n  #geom_line(data=baseline,aes(x=Age,y=value),color=\"black\",linetype=\"dashed\",size=1)+\n  facet_wrap(.~Cohort,dir=\"v\")+\n  geom_text(aes(x=0,y=1,label=paste0(\"Cohort \",Cohort)),fontface=\"plain\",hjust=0)+\n  ylab(\"Proportions\") + \n  # scale_colour_manual(values=c(\"orange\",\"blue\",\"red\")) +\n  scale_colour_manual(values=c(\"seagreen3\",\"purple4\",\"darkorange2\")) +\n  scale_y_continuous(limits=c(0,1.05),breaks=c(0,0.25,0.5,0.75,1),labels=c(0,\"\",0.5,\"\",1))+\n  theme_classic()+\n  theme(axis.title.x = element_text(size=font.size),\n        axis.title.y = element_text(size=font.size),\n        axis.text.y = element_text(size=font.size-4,hjust=0.5,angle=90),\n        axis.text.x = element_text(size=font.size-4),\n        legend.text = element_text(size=font.size-2),\n        legend.position=\"bottom\",\n        legend.direction = \"horizontal\",\n        legend.justification = \"center\",\n        legend.margin = margin(0,0,0,0,unit=\"mm\"),\n        legend.title = element_blank(),\n        legend.background = element_blank(),\n        panel.spacing = unit(0,\"lines\"),\n        strip.background = element_blank(),\n        strip.text.x = element_blank(),\n        panel.border = element_rect(color=\"black\", fill=NA))\n#dev.off()\n\n\n##################################\n# Plot antibody observations\n##################################\ncomp_samp_size = 50\nantibody_comp_samp_size = 200\nsurvey_cv = 0.3\nobs_years = 1:nyr\nobservations <- fun_obs_mod(obs_years,Nya,comp_samp_size,catch_comp_samp_size,\n                            predicted_comps,survey_slx,dis_survey_slx,\n                            predicted_immune_comps,antibody_comp_samp_size,\n                            predicted_survey,survey_cv,Cya,N_catch,\n                            true_samp_prev,\n                            rseed)\n\nantibodies <- observations$antibody_obs\n\n# Calculate age-specific serpositive from overall sample\nseropositive <- t(apply(antibodies,1,function(x) x[seq(1,2*nage,by=2)]/sum(x)))\ncolnames(seropositive) <- paste0(0:(nage-1))\n\n# Calculate age composition of overall sample\nsamp_comp <- t(apply(antibodies,1,function(x) (x[seq(1,2*nage,by=2)]+x[seq(2,2*nage,by=2)])/sum(x)))\ncolnames(samp_comp) <- paste0(0:(nage-1))\n\n# Melt these objects and joiong together\nseropositive <- melt(data.frame(year=1:nyr,\n                                seropositive),id='year',variable.name='age',value.name='seropositive')\nsamp_comp <- melt(data.frame(year=1:nyr,\n                             samp_comp),id='year',variable.name='age',value.name='age_comp')\n\nfinal_antibodies <- inner_join(samp_comp,seropositive)\nfinal_antibodies <- filter(final_antibodies,!age%in%c('Age.0','Age.1'))\n\nfinal_antibodies$age <- (0:7)[match(final_antibodies$age,unique(final_antibodies$age))]\n\ndat.2.plot <- filter(final_antibodies,year %in% years.4.analysis) %>% mutate(year=year)\ndat.2.plot <- melt(dat.2.plot,id = c('year','age'))\n\n# Now plot\nC.plot <- ggplot(data=dat.2.plot) + \n  geom_col(aes(x=age, y=value, fill=variable, group=variable),position = 'identity')+\n  # geom_col(aes(x=age, y=seropositive,group=year),fill=\"grey75\")+\n  # facet_wrap(year~.,dir=\"v\",nrow=10)+\n  scale_fill_manual(values = c('age_comp'=\"black\",'seropositive'='grey75'),\n                    labels = c('- antibodies','+ antibodies')) + \n  facet_wrap(year~.,dir=\"v\",nrow=13)+\n  geom_text(aes(x=0,y=0.95,label=paste0(\"Year \",year)),fontface=\"plain\",hjust=0)+\n  labs(y=\"Sample seroprevalence (size=200)\")+\n  xlab(\"Age\")+\n  theme_classic()+\n  scale_y_continuous(limits=c(0,1.15),breaks=c(0,0.5,1),labels=c(0,0.5,1))+\n  theme(strip.background = element_blank(),\n        strip.text.x = element_blank(),\n        panel.border=element_rect(fill=NA),\n        plot.title = element_text(hjust = 0.5),\n        axis.title.y = element_text(size=font.size),\n        axis.title.x = element_text(size=font.size),\n        axis.text.y = element_text(size=font.size-5,hjust=0.5,angle=90),\n        axis.text.x = element_text(size=font.size-4),\n        axis.ticks.x= element_line(color=\"black\"),\n        #axis.title.y = element_blank(),\n        #legend.position =\"none\",\n        legend.title = element_blank(),\n        legend.position=c(0.55,0.01),\n        legend.justification = c(0,0.5),\n        legend.text=element_text(size=font.size-3),\n        legend.background = element_blank(),\n        plot.margin = margin(0.5, 0.5, 0.5, 0.5, \"cm\"),\n        panel.spacing = unit(0, \"lines\"))\n\n# ggsave(filename=here::here(paste0(\"results/figures/Figure_example seroprevalence seed \",rseed,\".png\")),width=8, height=6, units=\"in\",dpi=600)\n\n##################################\n# Combine plots into one giant one\n##################################\n\nprofile.plot.1 <- cowplot::ggdraw() +\n  cowplot::draw_plot(A.plot, 0, 2/3, 2/3, 1/3) +\n  cowplot::draw_plot(B.plot, 0, 0, 2/3, 2/3) +\n  cowplot::draw_plot(C.plot, 2/3, 0, 1/3, 1) +\n  cowplot::draw_plot_label(c(\"A\", \"B\", \"C\"), c(0, 0, 2/3), c(1, 2/3, 1), size = 18)\nggsave(filename=here::here(paste0(\"results/figures/Figure_age and cohort profiles_seed \",rseed,\".png\")),\n       plot=profile.plot.1,width=10, height=8, units=\"in\",dpi=600)  \n\n\n\n\n\n\n\n\n# EXPLORATORY\n##################################\n# Peak prevalance VS Max infection probability (Beta_I)\n##################################\n\nsel_years <- 100:nyr\n\nplot((apply(beta_I_y,1,max)+apply(beta_C_y,1,max))[sel_years],max.prevalence[sel_years],ylab=\"Prevalence\",xlab=\"Infection probability\")\nabline(v=((1-exp(-vhs_mort_rate))+(1-exp(-vhs_rec_rate))),lty=\"dashed\")\n\nplot(apply(beta_C_y,1,max),max.prevalence,ylab=\"Prevalence\",xlab=\"Infection probability\")\n\nplot(apply(beta_I_y,1,max),apply(beta_C_y,1,max),ylab=\"Infection probability form Infected\",xlab=\"Infection probability from Carrier\")\n\n# Frequency of times infections exceed mortality & recovery\noutbreaks <- (apply(beta_I_y,1,max) + apply(beta_C_y,1,max)) > ((1-exp(-vhs_mort_rate))+(1-exp(-vhs_rec_rate)))\n# outbreaks <- max.prevalence >=0.2\nsum(outbreaks[sel_years])/length(sel_years)\nmedian(diff(which(outbreaks[sel_years])))\n\n# plot years following this definition\nmatplot(t(N_y_infected/N_y_daily)[,outbreaks],type=\"l\",lty=1,ylab=\"\",col=colorRampPalette(c(\"grey20\",\"grey90\"))(sum(outbreaks)), xaxt='n', yaxt='n',lwd=2,ylim=c(0,1))\naxis(side =1, seq(0,ndays,by=50), labels = F)\naxis(2, at = c(0,0.5,1),labels=c(0,0.5,1))\ntext(0,0.95,labels='b)',cex=1.4,adj=c(0,0.5))\ntitle(ylab=\"Infection prevalence\", line=2.5, cex.lab=1.4)\n\n##################################\n# R0\n##################################\n\n# Calculate R0 based on Final Epidemic Size\nS0 <- (N_y_susceptible/N_y_daily)[,1]\nSinf <- (N_y_susceptible/N_y_daily)[,ndays]\nR0 <- (log(S0)-log(Sinf))/(S0-Sinf)\nplot(density(R0))\nabline(v=1)\n\n# Calculate R0 form SIR Flows\n# Beta = mean transmission rate, gamma = recovery rate, and mu = nautral mortality rate\n# R0 = beta/(gamma+mu)\nvhs_trans_rate_I=0.01\nvhs_trans_rate_C=0.000001\n\ndis_mort_rate <- 21/365 # 11/365\nrec_rate <- 20/365 # 26/365\nnat_mort_rate <- 0.25/365\n\nR0 <- (vhs_trans_rate_I + vhs_trans_rate_C)/(dis_mort_rate + rec_rate + nat_mort_rate)\n\n\n##################################\n# Age-specific mortality resulting from disease over time\n##################################\nlibrary(reshape2)\nlibrary(ggplot2)\nlibrary(ggridges)\n#add_mort <- t(apply(Sya,1,function(x) -log(x)-c(rep(0.25,times=nage-1),1.8)))\nadd_mort <- t(apply(Sya[(nyr-50):nyr,],1,function(x) -log(x)))\nadd_mort <- melt(add_mort,varnames=c(\"Year\",\"Age\"))\n\n# One with ridge lines\nggplot(add_mort,aes(x=Age,y=Year,height=value, group=Year)) +\n  geom_ridgeline()+\n  theme_classic()\n\n# One with facets\nggplot(add_mort,aes(x=Year,y=value,group=Age)) +\n  geom_line()+\n  facet_wrap(.~Age)+\n  theme_classic()\n\n\n##################################\n# Age-specific mortality VS age-specific immunity\n##################################\nlibrary(dplyr)\nage_survival <- melt(Sya[(nyr-50):nyr,],varnames=c(\"Year\",\"Age\"),value.name=\"Survival\")\n\nadd_mort <- t(apply(Sya[(nyr-50):nyr,],1,function(x) -log(x)))\nadd_mort <- melt(add_mort,varnames=c(\"Year\",\"Age\"),value.name=\"Mortality\")\n\nage_immune <- melt(predicted_immune_comps[(nyr-50):nyr,],varnames=c(\"Year\",\"Age\"),value.name=\"Immunity\")\n\nmort_vs_immune <- full_join(full_join(age_survival,add_mort,by=c(\"Year\",\"Age\")),age_immune,by=c(\"Year\",\"Age\"))\n\n# Arrange by year first, then age\nmort_vs_immune <- arrange(mort_vs_immune,Year,Age) %>% \n  mutate(Year_lag1=Year-1,\n         Age_lag1=Age-1)\n\nmort_vs_immune <- mort_vs_immune %>% mutate(Immunity_lead1=Immunity[prodlim::row.match(select(mort_vs_immune,Year,Age),select(mort_vs_immune,Year_lag1,Age_lag1))])\n\n# This is the immunity preceding this year's mortality\nggplot(mort_vs_immune,aes(x=Immunity,y=Survival,group=Age)) +\n  geom_point()+\n  geom_line()+\n  facet_wrap(.~Age)+\n  theme_classic()\n\n# This is the immunity following this year's mortality\nggplot(mort_vs_immune,aes(x=Mortality,y=Immunity_lead1,group=Age)) +\n  geom_point()+\n  geom_line()+\n  facet_wrap(.~Age)+\n  theme_classic()\n\n\n##################################\n# Age-structure VS age-immunity\n##################################\nlibrary(dplyr)\nage_comp <-t(apply(Nya[(nyr-50):nyr,],1,function(x) x/sum(x)))\nage_comp <- melt(age_comp,varnames=c(\"Year\",\"Age\"),value.name=\"Age_structure\")\n\nage_immune <- melt(predicted_immune_comps[(nyr-50):nyr,],varnames=c(\"Year\",\"Age\"),value.name=\"Immunity\")\n\nstructure_vs_immune <- full_join(age_comp,age_immune,by=c(\"Year\",\"Age\"))\ntrial <- structure_vs_immune %>% group_by(Age) %>% mutate(lagged_structure=lag(Age_structure))\n\n# One with facets\nggplot(structure_vs_immune,aes(x=lagged_structure,y=Immunity,group=Age)) +\n  geom_point()+\n  geom_line()+\n  facet_wrap(.~Age)+\n  theme_classic()\n",
    "created" : 1632316174761.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3873372808",
    "id" : "DEC0C630",
    "lastKnownWriteTime" : 1632316600,
    "last_content_update" : 1632316600934,
    "path" : "~/IDrive-Sync/Thesis/antibody_sim/src/om_exploration.R",
    "project_path" : "src/om_exploration.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}